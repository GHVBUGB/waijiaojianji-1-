<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è…¾è®¯äº‘ä¸‡è±¡APIæµ‹è¯•</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            margin: 0;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 30px;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .header h1 {
            color: #333;
            margin-bottom: 10px;
        }
        .status-card {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        .status-success { border-left: 4px solid #28a745; }
        .status-running { border-left: 4px solid #007bff; }
        .status-failed { border-left: 4px solid #dc3545; }
        .status-pending { border-left: 4px solid #ffc107; }
        
        .btn {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .btn:hover {
            background: #0056b3;
        }
        .btn-success {
            background: #28a745;
        }
        .btn-success:hover {
            background: #1e7e34;
        }
        .log-area {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .job-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¯ è…¾è®¯äº‘ä¸‡è±¡APIæµ‹è¯•</h1>
            <p>æ£€æŸ¥è§†é¢‘æŠ å›¾ä»»åŠ¡çŠ¶æ€å’Œä¸‹è½½ç»“æœ</p>
        </div>

        <div class="status-card">
            <h3>ğŸ“‹ å½“å‰ä»»åŠ¡çŠ¶æ€</h3>
            <p><strong>ä»»åŠ¡ID:</strong> <span id="currentJobId">ab11f32d6a4d511f0b65ddf415e607aff</span></p>
            <input type="text" id="jobIdInput" class="job-input" placeholder="è¾“å…¥ä»»åŠ¡ID" value="ab11f32d6a4d511f0b65ddf415e607aff">
            <button class="btn" onclick="checkJobStatus()">ğŸ” æ£€æŸ¥çŠ¶æ€</button>
            <button class="btn" onclick="downloadResult()">ğŸ“¥ ä¸‹è½½ç»“æœ</button>
            <button class="btn btn-success" onclick="startAutoCheck()">ğŸ”„ è‡ªåŠ¨æ£€æŸ¥</button>
            <button class="btn" onclick="stopAutoCheck()">â¹ï¸åœæ­¢æ£€æŸ¥</button>
        </div>

        <div class="status-card" id="statusDisplay">
            <h4>çŠ¶æ€ä¿¡æ¯</h4>
            <p id="statusText">ç‚¹å‡»"æ£€æŸ¥çŠ¶æ€"å¼€å§‹</p>
        </div>

        <div class="status-card">
            <h4>ğŸ“„ æ“ä½œæ—¥å¿—</h4>
            <div class="log-area" id="logArea"></div>
            <button class="btn" onclick="clearLog()">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
        </div>

        <div class="status-card">
            <h4>ğŸ¥ è§†é¢‘é¢„è§ˆ</h4>
            <div id="videoPreview">
                <p>å¤„ç†å®Œæˆåï¼Œè§†é¢‘å°†åœ¨è¿™é‡Œæ˜¾ç¤º</p>
            </div>
        </div>
    </div>

    <script>
        let autoCheckInterval = null;
        let checkCount = 0;

        function log(message) {
            const logArea = document.getElementById('logArea');
            const timestamp = new Date().toLocaleTimeString();
            logArea.textContent += `[${timestamp}] ${message}\n`;
            logArea.scrollTop = logArea.scrollHeight;
        }

        function clearLog() {
            document.getElementById('logArea').textContent = '';
        }

        async function checkJobStatus() {
            const jobId = document.getElementById('jobIdInput').value.trim();
            if (!jobId) {
                log('âŒ è¯·è¾“å…¥ä»»åŠ¡ID');
                return;
            }

            log(`ğŸ” æ£€æŸ¥ä»»åŠ¡çŠ¶æ€: ${jobId}`);
            
            try {
                // ç›´æ¥è°ƒç”¨è…¾è®¯äº‘ä¸‡è±¡APIæ£€æŸ¥çŠ¶æ€
                const response = await fetch('/check-ci-status', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ job_id: jobId })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const result = await response.json();
                updateStatusDisplay(result);
                log(`âœ… çŠ¶æ€æ£€æŸ¥å®Œæˆ: ${result.state}`);

                if (result.state === 'Success') {
                    log('ğŸ‰ ä»»åŠ¡å®Œæˆï¼å¯ä»¥ä¸‹è½½ç»“æœäº†');
                    showDownloadButton();
                } else if (result.state === 'Failed') {
                    log('âŒ ä»»åŠ¡å¤±è´¥');
                } else {
                    log('â³ ä»»åŠ¡è¿˜åœ¨å¤„ç†ä¸­...');
                }

            } catch (error) {
                log(`âŒ æ£€æŸ¥å¤±è´¥: ${error.message}`);
                console.error('çŠ¶æ€æ£€æŸ¥é”™è¯¯:', error);
            }
        }

        function updateStatusDisplay(result) {
            const statusDisplay = document.getElementById('statusDisplay');
            const statusText = document.getElementById('statusText');
            
            // ç§»é™¤æ‰€æœ‰çŠ¶æ€ç±»
            statusDisplay.className = 'status-card';
            
            // æ·»åŠ å¯¹åº”çš„çŠ¶æ€ç±»
            switch(result.state) {
                case 'Success':
                    statusDisplay.classList.add('status-success');
                    break;
                case 'Running':
                    statusDisplay.classList.add('status-running');
                    break;
                case 'Failed':
                    statusDisplay.classList.add('status-failed');
                    break;
                default:
                    statusDisplay.classList.add('status-pending');
            }

            statusText.innerHTML = `
                <strong>çŠ¶æ€:</strong> ${result.state}<br>
                <strong>æ£€æŸ¥æ—¶é—´:</strong> ${new Date().toLocaleString()}<br>
                <strong>ä»»åŠ¡ID:</strong> ${result.job_id || 'æœªçŸ¥'}
            `;
        }

        function showDownloadButton() {
            const videoPreview = document.getElementById('videoPreview');
            videoPreview.innerHTML = `
                <button class="btn btn-success" onclick="downloadResult()">
                    ğŸ“¥ ä¸‹è½½å¤„ç†åçš„è§†é¢‘
                </button>
                <p>ä»»åŠ¡å·²å®Œæˆï¼Œç‚¹å‡»ä¸‹è½½æŒ‰é’®è·å–ç»“æœ</p>
            `;
        }

        async function downloadResult() {
            const jobId = document.getElementById('jobIdInput').value.trim();
            if (!jobId) {
                log('âŒ è¯·è¾“å…¥ä»»åŠ¡ID');
                return;
            }

            log(`ğŸ“¥ å¼€å§‹ä¸‹è½½ç»“æœ: ${jobId}`);
            
            try {
                // è°ƒç”¨ä¸‹è½½API
                const response = await fetch('/download-ci-result', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ job_id: jobId })
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ci_processed_${jobId}.mp4`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                log('âœ… ä¸‹è½½å¼€å§‹');
                
                // æ˜¾ç¤ºè§†é¢‘é¢„è§ˆ
                showVideoPreview(url);

            } catch (error) {
                log(`âŒ ä¸‹è½½å¤±è´¥: ${error.message}`);
                console.error('ä¸‹è½½é”™è¯¯:', error);
            }
        }

        function showVideoPreview(videoUrl) {
            const videoPreview = document.getElementById('videoPreview');
            videoPreview.innerHTML = `
                <video controls width="100%" style="max-width: 500px; border-radius: 8px;">
                    <source src="${videoUrl}" type="video/mp4">
                    æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾
                </video>
                <p>âœ… è§†é¢‘ä¸‹è½½å®Œæˆå¹¶é¢„è§ˆ</p>
            `;
        }

        function startAutoCheck() {
            if (autoCheckInterval) {
                clearInterval(autoCheckInterval);
            }
            
            checkCount = 0;
            log('ğŸ”„ å¼€å§‹è‡ªåŠ¨æ£€æŸ¥ï¼ˆæ¯30ç§’ä¸€æ¬¡ï¼‰');
            
            // ç«‹å³æ£€æŸ¥ä¸€æ¬¡
            checkJobStatus();
            
            // è®¾ç½®å®šæ—¶æ£€æŸ¥
            autoCheckInterval = setInterval(() => {
                checkCount++;
                log(`ğŸ”„ è‡ªåŠ¨æ£€æŸ¥ #${checkCount}`);
                checkJobStatus();
                
                // æœ€å¤šæ£€æŸ¥20æ¬¡ï¼ˆ10åˆ†é’Ÿï¼‰
                if (checkCount >= 20) {
                    stopAutoCheck();
                    log('â° è‡ªåŠ¨æ£€æŸ¥å·²è¾¾åˆ°æœ€å¤§æ¬¡æ•°ï¼Œå·²åœæ­¢');
                }
            }, 30000);
        }

        function stopAutoCheck() {
            if (autoCheckInterval) {
                clearInterval(autoCheckInterval);
                autoCheckInterval = null;
                log('â¹ï¸ è‡ªåŠ¨æ£€æŸ¥å·²åœæ­¢');
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            log('ğŸš€ è…¾è®¯äº‘ä¸‡è±¡APIæµ‹è¯•é¡µé¢å·²åŠ è½½');
            log('ğŸ’¡ æç¤ºï¼šå¯ä»¥è¾“å…¥ä»»åŠ¡IDå¹¶ç‚¹å‡»æ£€æŸ¥çŠ¶æ€');
        });
    </script>
</body>
</html>
